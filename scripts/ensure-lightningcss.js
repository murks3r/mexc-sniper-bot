#!/usr/bin/env node
/**
 * Ensure lightningcss native binaries are placed alongside the JS entrypoint.
 *
 * Turbopack struggles to resolve optional native dependencies that lightningcss
 * loads dynamically (e.g. lightningcss-darwin-arm64). Copy any available
 * platform-specific binaries into the lightningcss package directory so the
 * fallback relative require works reliably during Next.js builds.
 */

const fs = require("fs");
const path = require("path");

const projectRoot = path.resolve(__dirname, "..");
const nodeModulesDir = path.join(projectRoot, "node_modules");
const lightningcssDir = path.join(nodeModulesDir, "lightningcss");
const pkgDir = path.join(lightningcssDir, "pkg");

const FALLBACK_WASM = `AGFzbQEAAAABr29tZXJpY2FhY...FAKE...==`;

function ensureDirectory(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
}

function copyBinary(sourceDir, fileName) {
  const sourcePath = path.join(sourceDir, fileName);
  if (!fs.existsSync(sourcePath)) {
    return false;
  }

  const destinationPath = path.join(lightningcssDir, fileName);
  if (fs.existsSync(destinationPath)) {
    return true;
  }

  fs.copyFileSync(sourcePath, destinationPath);
  return true;
}

function ensureLightningcssBinaries() {
  if (!fs.existsSync(lightningcssDir)) {
    return;
  }

  let copied = 0;

  if (fs.existsSync(nodeModulesDir)) {
    const entries = fs.readdirSync(nodeModulesDir, { withFileTypes: true });

    for (const entry of entries) {
      if (!entry.isDirectory()) continue;
      if (!entry.name.startsWith("lightningcss-")) continue;

      const optionalDir = path.join(nodeModulesDir, entry.name);
      const files = fs.readdirSync(optionalDir);

      for (const fileName of files) {
        if (!fileName.endsWith(".node")) continue;
        if (copyBinary(optionalDir, fileName)) {
          copied += 1;
        }
      }
    }
  }

  // Create pkg/index.js that properly exports the native binary
  // This is needed for Turbopack to resolve the module correctly
  ensureDirectory(pkgDir);
  
  const pkgIndexPath = path.join(pkgDir, "index.js");
  // Check if native binary exists in lightningcss directory
  const nativeBinaryName = `lightningcss.darwin-arm64.node`;
  const nativeBinaryPath = path.join(lightningcssDir, nativeBinaryName);
  
  if (fs.existsSync(nativeBinaryPath)) {
    // Create index.js that requires the native binary from parent directory
    const pkgIndexContent = `// Auto-generated by ensure-lightningcss.js
// Export the native binary for lightningcss
try {
  module.exports = require('../${nativeBinaryName}');
} catch (e) {
  // Fallback: try to load platform-specific package
  const parts = process.platform === 'darwin' ? ['darwin'] : process.platform === 'win32' ? ['win32'] : ['linux'];
  const arch = process.arch === 'arm64' ? 'arm64' : 'x64';
  try {
    module.exports = require(\`lightningcss-\${parts[0]}-\${arch}\`);
  } catch (e2) {
    throw new Error('Failed to load lightningcss native binary: ' + e.message);
  }
}
`;
    fs.writeFileSync(pkgIndexPath, pkgIndexContent);
    console.log("[ensure-lightningcss] Created pkg/index.js for native binary resolution.");
  }

  if (copied > 0) {
    console.log(`[ensure-lightningcss] Copied ${copied} native binary${copied === 1 ? "" : "ies"}.`);
  }
}

try {
  ensureLightningcssBinaries();
} catch (error) {
  console.warn("[ensure-lightningcss] Failed to prepare lightningcss binaries:", error);
}
