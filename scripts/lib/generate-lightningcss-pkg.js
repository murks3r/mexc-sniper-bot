const osFlavorParts = (platform, arch) => {
  const parts = [platform, arch];

  if (platform === "linux") {
    try {
      const { MUSL, familySync } = require("detect-libc");
      const family = familySync();
      if (family === MUSL) {
        parts.push("musl");
      } else if (arch === "arm") {
        parts.push("gnueabihf");
      } else {
        parts.push("gnu");
      }
    } catch {
      parts.push("gnu");
    }
  } else if (platform === "win32") {
    parts.push("msvc");
  }

  return parts;
};

function generateLightningcssPkgIndex({ nativeBinaryName, platform, arch }) {
  const platformPartsLiteral = JSON.stringify(osFlavorParts(platform, arch));

  return `// Auto-generated by ensure-lightningcss.js
// Export the native binary for lightningcss with relative path resolution
const path = require('path');
const fs = require('fs');

function loadNativeBinary() {
  const pkgDir = __dirname;
  const lightningcssDir = path.resolve(pkgDir, '..');
  const nativePath = path.join(lightningcssDir, '${nativeBinaryName}');

  if (fs.existsSync(nativePath)) {
    try {
      return require('../${nativeBinaryName}');
    } catch (e) {
      // Continue with fallbacks
    }
  }

  try {
    const parts = ${platformPartsLiteral};
    return require(\`lightningcss-\${parts.join('-')}\`);
  } catch (e) {
    try {
      return require(nativePath);
    } catch (e2) {
      throw new Error('Failed to load lightningcss native binary. Tried: ' + nativePath + '. Original error: ' + e2.message);
    }
  }
}

module.exports = loadNativeBinary();
`;
}

module.exports = {
  generateLightningcssPkgIndex,
};

