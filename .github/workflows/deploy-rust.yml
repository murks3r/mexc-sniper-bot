name: Deploy Rust Backend to AWS EC2

on:
  push:
    branches:
      - main
      - deploy/rust
    paths:
      - 'backend-rust/**'
      - '.github/workflows/deploy-rust.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-southeast-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-southeast-1.amazonaws.com
  DOCKER_IMAGE_NAME: mexc-sniper-rust
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build Rust Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: backend-rust

      - name: Build Rust backend (Release)
        working-directory: backend-rust
        run: |
          cargo build --release --target x86_64-unknown-linux-musl
          ls -lh target/x86_64-unknown-linux-musl/release/mexc-sniper

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: mexc-sniper-binary
          path: backend-rust/target/x86_64-unknown-linux-musl/release/mexc-sniper
          retention-days: 1

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: mexc-sniper-binary
          path: backend-rust/target/x86_64-unknown-linux-musl/release/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | \
          docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Create ECR repository if it doesn't exist
        run: |
          aws ecr describe-repositories --repository-names $DOCKER_IMAGE_NAME || \
          aws ecr create-repository --repository-name $DOCKER_IMAGE_NAME --region $AWS_REGION

      - name: Build Docker image
        working-directory: backend-rust
        run: |
          docker build -t $ECR_REGISTRY/$DOCKER_IMAGE_NAME:$GITHUB_SHA .
          docker tag $ECR_REGISTRY/$DOCKER_IMAGE_NAME:$GITHUB_SHA $ECR_REGISTRY/$DOCKER_IMAGE_NAME:latest

      - name: Push to ECR
        run: |
          docker push $ECR_REGISTRY/$DOCKER_IMAGE_NAME:$GITHUB_SHA
          docker push $ECR_REGISTRY/$DOCKER_IMAGE_NAME:latest

      - name: Save image URI
        run: |
          echo "IMAGE_URI=$ECR_REGISTRY/$DOCKER_IMAGE_NAME:$GITHUB_SHA" >> $GITHUB_ENV

  deploy:
    name: Blue-Green Deployment to EC2
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 instance details
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=mexc-sniper-bot" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --region $AWS_REGION \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Instance ID: $INSTANCE_ID"

      - name: Copy deployment scripts to EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AWS_EC2_IP }} >> ~/.ssh/known_hosts
          scp -i ~/.ssh/id_rsa scripts/deploy-blue-green.sh ec2-user@${{ secrets.AWS_EC2_IP }}:/tmp/deploy-blue-green.sh
          scp -i ~/.ssh/id_rsa scripts/deployment-status.sh ec2-user@${{ secrets.AWS_EC2_IP }}:/tmp/deployment-status.sh
          
      - name: Execute blue-green deployment on EC2
        id: deploy
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.AWS_EC2_IP }} << 'DEPLOY_SCRIPT'
            export AWS_REGION=${{ env.AWS_REGION }}
            export ECR_REGISTRY=${{ env.ECR_REGISTRY }}
            export DOCKER_IMAGE_NAME=${{ env.DOCKER_IMAGE_NAME }}
            export IMAGE_TAG=${{ github.sha }}
            export MEXC_API_KEY="${{ secrets.MEXC_API_KEY }}"
            export MEXC_SECRET_KEY="${{ secrets.MEXC_SECRET_KEY }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export RUST_LOG=info
            
            chmod +x /tmp/deploy-blue-green.sh
            bash /tmp/deploy-blue-green.sh
          DEPLOY_SCRIPT

      - name: Retrieve deployment logs and metrics
        if: always()
        run: |
          echo "========================================"
          echo "Retrieving deployment artifacts..."
          echo "========================================"
          
          # Get the latest deployment log
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.AWS_EC2_IP }} \
            'ls -t /tmp/deployment-*.log 2>/dev/null | head -1' > /tmp/latest-log-path.txt || true
          
          if [ -s /tmp/latest-log-path.txt ]; then
            LATEST_LOG=$(cat /tmp/latest-log-path.txt)
            echo "Latest deployment log: $LATEST_LOG"
            
            scp -i ~/.ssh/id_rsa ec2-user@${{ secrets.AWS_EC2_IP }}:$LATEST_LOG ./deployment.log || true
            
            if [ -f ./deployment.log ]; then
              echo ""
              echo "========================================"
              echo "DEPLOYMENT LOG"
              echo "========================================"
              cat ./deployment.log
            fi
          fi
          
          # Get the latest metrics file
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.AWS_EC2_IP }} \
            'ls -t /tmp/deployment-metrics-*.json 2>/dev/null | head -1' > /tmp/latest-metrics-path.txt || true
          
          if [ -s /tmp/latest-metrics-path.txt ]; then
            LATEST_METRICS=$(cat /tmp/latest-metrics-path.txt)
            echo "Latest deployment metrics: $LATEST_METRICS"
            
            scp -i ~/.ssh/id_rsa ec2-user@${{ secrets.AWS_EC2_IP }}:$LATEST_METRICS ./deployment-metrics.json || true
            
            if [ -f ./deployment-metrics.json ]; then
              echo ""
              echo "========================================"
              echo "DEPLOYMENT METRICS"
              echo "========================================"
              cat ./deployment-metrics.json | jq '.' || cat ./deployment-metrics.json
            fi
          fi

      - name: Generate deployment status report
        if: always()
        run: |
          echo "========================================"
          echo "DEPLOYMENT STATUS REPORT"
          echo "========================================"
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.AWS_EC2_IP }} << 'STATUS_SCRIPT'
            chmod +x /tmp/deployment-status.sh
            bash /tmp/deployment-status.sh
          STATUS_SCRIPT

      - name: Verify deployment health
        if: success()
        run: |
          echo "========================================"
          echo "FINAL HEALTH VERIFICATION"
          echo "========================================"
          
          sleep 5
          
          # Check /health endpoint
          echo "Testing /health endpoint..."
          if curl -f -s http://${{ secrets.AWS_EC2_IP }}:8080/health; then
            echo "‚úÖ /health endpoint is responding"
          else
            echo "‚ùå /health endpoint failed"
            exit 1
          fi
          
          echo ""
          
          # Test actual API response
          echo "Full health response:"
          curl -s http://${{ secrets.AWS_EC2_IP }}:8080/health | jq '.' || curl -s http://${{ secrets.AWS_EC2_IP }}:8080/health

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: deployment-artifacts-${{ github.sha }}
          path: |
            deployment.log
            deployment-metrics.json
          retention-days: 30

      - name: Deployment summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "DEPLOYMENT SUMMARY"
          echo "========================================"
          echo "Deployment ID: ${{ github.sha }}"
          echo "Deployment Status: ${{ job.status }}"
          echo "Target: EC2 (${{ secrets.AWS_EC2_IP }})"
          echo "Image: ${{ env.ECR_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}"
          echo "Strategy: Blue-Green Deployment"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "========================================"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment completed successfully with zero downtime"
            echo "üìä Deployment artifacts available in workflow artifacts"
          else
            echo "‚ùå Deployment failed - check logs above for details"
            exit 1
          fi

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: [build, docker-build, deploy]

    steps:
      - name: Rollback deployment
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AWS_EC2_IP }} >> ~/.ssh/known_hosts
          
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.AWS_EC2_IP }} << 'EOF'
            docker stop mexc-sniper-blue 2>/dev/null || true
            docker rm mexc-sniper-blue 2>/dev/null || true
            
            if docker ps -a --format '{{.Names}}' | grep -q '^mexc-sniper-green$'; then
              docker rename mexc-sniper-green mexc-sniper-blue
              docker start mexc-sniper-blue
              echo "Rollback to previous version completed"
            fi
          EOF

      - name: Alert on rollback
        run: |
          echo "‚ö†Ô∏è Deployment failed and rolled back to previous version"
