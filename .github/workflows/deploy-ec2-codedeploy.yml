name: AWS CodeDeploy to EC2 (Osaka)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-3  # Osaka region
  APPLICATION_NAME: mexc-sniper-bot
  DEPLOYMENT_GROUP_NAME: mexc-sniper-bot-deployment-group

jobs:
  deploy:
    name: Deploy to EC2 via CodeDeploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          # Exclude unnecessary files from deployment
          zip -r deployment.zip . \
            -x "*.git*" \
            -x "*node_modules*" \
            -x "*.env*" \
            -x "*test-results*" \
            -x "*.next*" \
            -x "*__tests__*" \
            -x "*.cache*" \
            -x "*coverage*" \
            -x "*.turbo*"
          
          echo "Deployment package created: $(du -h deployment.zip)"

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          S3_KEY="deployments/${GITHUB_SHA:0:7}_${TIMESTAMP}.zip"
          
          echo "Uploading deployment package to S3..."
          aws s3 cp deployment.zip \
            s3://${{ secrets.AWS_S3_BUCKET }}/$S3_KEY \
            --region ${{ env.AWS_REGION }}
          
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV
          echo "‚úÖ Upload complete: s3://${{ secrets.AWS_S3_BUCKET }}/$S3_KEY"

      - name: Create CodeDeploy deployment
        id: deploy
        run: |
          echo "Creating CodeDeploy deployment..."
          
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.APPLICATION_NAME }} \
            --deployment-group-name ${{ env.DEPLOYMENT_GROUP_NAME }} \
            --s3-location bucket=${{ secrets.AWS_S3_BUCKET }},key=${{ env.S3_KEY }},bundleType=zip \
            --deployment-config-name CodeDeployDefault.OneAtATime \
            --description "Deployment from GitHub Actions - Commit ${GITHUB_SHA:0:7}" \
            --region ${{ env.AWS_REGION }} \
            --query 'deploymentId' \
            --output text)
          
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment created: $DEPLOYMENT_ID"

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment ${{ env.DEPLOYMENT_ID }} to complete..."
          
          aws deploy wait deployment-successful \
            --deployment-id ${{ env.DEPLOYMENT_ID }} \
            --region ${{ env.AWS_REGION }}
          
          echo "‚úÖ Deployment completed successfully!"

      - name: Get deployment status
        if: always()
        run: |
          echo "Fetching deployment status..."
          
          aws deploy get-deployment \
            --deployment-id ${{ env.DEPLOYMENT_ID }} \
            --region ${{ env.AWS_REGION }} \
            --query 'deploymentInfo.status' \
            --output text

      - name: Notify deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚úÖ EC2 Deployment Success (Osaka) - ${now}`,
              body: `üöÄ **EC2 Deployment Completed Successfully**
              
              **Deployment Details:**
              - **Region:** ap-northeast-3 (Osaka)
              - **Deployment ID:** ${{ env.DEPLOYMENT_ID }}
              - **Commit:** ${context.sha.substring(0, 7)}
              - **Branch:** ${context.ref.replace('refs/heads/', '')}
              - **Triggered by:** ${context.actor}
              - **Timestamp:** ${now}
              
              **AWS Resources:**
              - **Application:** ${{ env.APPLICATION_NAME }}
              - **Deployment Group:** ${{ env.DEPLOYMENT_GROUP_NAME }}
              - **S3 Bucket:** ${{ secrets.AWS_S3_BUCKET }}
              - **S3 Key:** ${{ env.S3_KEY }}
              
              **Next Steps:**
              - Monitor application health via AWS Console
              - Check CloudWatch logs for any errors
              - Verify application is running: Check EC2 instance
              
              This issue was automatically created by the deployment pipeline.`,
              labels: ['deployment', 'ec2', 'success', 'osaka']
            })

      - name: Notify deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ùå EC2 Deployment Failed (Osaka) - ${now}`,
              body: `üö® **EC2 Deployment Failed**
              
              **Deployment Details:**
              - **Region:** ap-northeast-3 (Osaka)
              - **Deployment ID:** ${{ env.DEPLOYMENT_ID || 'Not created' }}
              - **Commit:** ${context.sha.substring(0, 7)}
              - **Branch:** ${context.ref.replace('refs/heads/', '')}
              - **Triggered by:** ${context.actor}
              - **Timestamp:** ${now}
              
              **Failure Information:**
              Check the [deployment logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for detailed error information.
              
              **Troubleshooting Steps:**
              1. Check CodeDeploy console for deployment errors
              2. Review EC2 instance logs at /var/log/aws/codedeploy-agent/
              3. Verify IAM permissions for deployment
              4. Check S3 bucket accessibility
              5. Verify deployment scripts are working correctly
              
              **Action Required:**
              - Review deployment logs
              - Fix identified issues
              - Re-run deployment once resolved
              
              This issue was automatically created by the deployment pipeline.`,
              labels: ['deployment', 'ec2', 'failed', 'urgent', 'osaka']
            })
